name: Publish Helm Chart
description: Package and publish a Helm chart (Chart Releaser). Accepts chart path and branch inputs.
inputs:
    chart-path:
        description: "Path to the Helm chart (example: deploy/recipe-extractor)"
        required: true
    branch-name:
        description: "Branch name (optional). If empty the action will use the current ref."
        required: true
    registry-token:
        description: "Token used by chart-releaser (usually GITHUB_TOKEN)"
        required: true
runs:
    using: "composite"
    steps:
        - name: Install Helm
          uses: azure/setup-helm@v4

        - name: Package Helm Chart
          shell: bash
          run: |
              set -euo pipefail
              CHART_PATH="${{ inputs.chart-path }}"
              BRANCH="${{ inputs.branch-name }}"

              SAFE_NAME=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/^-//;s/-$//')
              BRANCH_PREFIX=$(echo "$SAFE_NAME" | cut -c1-20 | sed 's/-$//')

              # read declared Chart.yaml version
              CHART_VERSION=$(grep '^version:' "$CHART_PATH/Chart.yaml" | awk '{print $2}')

              if [ "$BRANCH" = "release" ]; then
                PACKAGE_VERSION="$CHART_VERSION"
              elif [ "$BRANCH" = "main" ]; then
                PACKAGE_VERSION="${CHART_VERSION}-staging.${GITHUB_SHA::8}"
              else
                PACKAGE_VERSION="${CHART_VERSION}-${BRANCH_PREFIX}.${GITHUB_SHA::8}"
              fi

              echo "Packaging chart version: $PACKAGE_VERSION"
              # update version in Chart.yaml (temporary)
              sed -i "s/^version:.*/version: $PACKAGE_VERSION/" "$CHART_PATH/Chart.yaml"
              mkdir -p .helm-packages
              helm package "$CHART_PATH" -d .helm-packages
              CHART_PKG=$(ls .helm-packages/*.tgz | head -n1)

              echo "package-version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
              echo "chart-package=$CHART_PKG" >> $GITHUB_OUTPUT

        - name: Configure Git
          shell: bash
          run: |
              git config user.name "$GITHUB_ACTOR"
              git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

        - name: Run chart-releaser
          uses: helm/chart-releaser-action@v1.7.0
          env:
              CR_TOKEN: "${{ inputs.registry-token }}"
