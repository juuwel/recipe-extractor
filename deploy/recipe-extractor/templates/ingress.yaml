apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
    name: {{ .Release.Name }}-ingress
    namespace: {{ .Values.namespace }}
spec:
    entryPoints:
      {{- range .Values.ingressRoute.entryPoints }}
      - {{ . }}
      {{- end }}
    routes:
      {{- range .Values.ingressRoute.routes }}
      - match: Host(`{{ $.Values.ingressRoute.host }}`) && PathPrefix(`{{ .path }}`)
        kind: Rule
        {{- if .priority }}
        priority: {{ .priority }}
        {{- end }}
        services:
          - name: {{ $.Release.Name }}
            port: {{ $.Values.service.port }}
        {{- if .middlewares }}
        middlewares:
          {{- range .middlewares }}
          - name: {{ . }}
          {{- end }}
        {{- end }}
      {{- end }}
    tls:
      certResolver: {{ .Values.tls.certResolver }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: basic-auth
  namespace: {{ .Values.namespace }}
spec:
  basicAuth:
    secret: basic-auth
